<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark Attendance - ERPLI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: "Inter", sans-serif; background-color: #F9FAFB; color: #1F2937; }
        
        /* Form Button (from other file) */
        .form-submit-button { display: flex; justify-content: center; align-items: center; gap: 0.5rem; background-color: #3B82F6; color: #ffffff; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.2s ease; }
        .form-submit-button:hover { background-color: #2563EB; }
        .form-submit-button:disabled { background-color: #9CA3AF; cursor: not-allowed; }

        /* NEW MOBILE-FRIENDLY BUTTONS
          This is the 2x2 grid style
        */
        .attendance-btn-group {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2 columns */
            border-radius: 0.375rem; /* 6px */
            overflow: hidden;
            border: 1px solid #D1D5DB; /* gray-300 */
        }
        .attendance-btn-group input[type="radio"] { display: none; }
        
        .attendance-btn {
            padding: 0.75rem 0.5rem; /* 12px 8px */
            color: #4B5563; /* gray-600 */
            font-weight: 500;
            font-size: 0.875rem; /* 14px */
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            /* Add borders to separate the grid */
            border-bottom: 1px solid #E5E7EB; /* gray-200 */
            border-right: 1px solid #E5E7EB; /* gray-200 */
        }
        
        /* Fix borders for the 2x2 grid */
        .btn-present, .btn-late { border-right-width: 1px; }
        .btn-absent, .btn-excused { border-right-width: 0; }
        .btn-present, .btn-absent { border-bottom-width: 1px; }
        .btn-late, .btn-excused { border-bottom-width: 0; }


        /* Present */
        .attendance-btn-group input[type="radio"]:checked + .attendance-btn.btn-present { background-color: #16A34A; color: white; border-color: #16A34A; }
        /* Absent */
        .attendance-btn-group input[type="radio"]:checked + .attendance-btn.btn-absent { background-color: #DC2626; color: white; border-color: #DC2626; }
        /* Late */
        .attendance-btn-group input[type="radio"]:checked + .attendance-btn.btn-late { background-color: #F59E0B; color: white; border-color: #F59E0B; }
        /* Excused */
        .attendance-btn-group input[type="radio"]:checked + .attendance-btn.btn-excused { background-color: #6B7280; color: white; border-color: #6B7280; }
        
        /* NEW STICKY FOOTER
          This keeps the save button visible on mobile
        */
        #save-footer {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 1rem;
            border-top: 1px solid #E5E7EB;
            backdrop-filter: blur(8px);
        }
    </style>
</head>
<body class="bg-gray-50">

    <main class="max-w-2xl mx-auto p-4 md:p-8">
        
        <div class="flex items-center gap-4 mb-6">
            <a href="teacher_attendance.html" class="flex items-center justify-center p-2 rounded-lg text-gray-500 hover:bg-gray-100 hover:text-gray-900">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </a>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Mark Attendance</h1>
        </div>

        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-2">Batch: <span id="batch-name">...</span></h2>
            <p class="text-sm text-gray-600">Date: <span id="attendance-date-display">...</span></p>
            <p id="status-message" class="text-sm font-medium mt-2 text-blue-600"></p>
        </div>
        
        <div id="student-list" class="space-y-3 mb-24">
            <p class="py-4 px-4 text-center text-gray-500">Loading students...</p>
        </div>
        
    </main>
    
    <footer id="save-footer">
        <button id="save-attendance-button" class="form-submit-button w-full">
            Save Attendance
        </button>
    </footer>


    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        const SUPABASE_URL = 'https://mclizdhmmzckhjnocktz.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jbGl6ZGhtbXpja2hqbm9ja3R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNDk5MzUsImV4cCI6MjA3NzgyNTkzNX0.zKvs2XDOvcJfb_mCDHOMsJwRKvUViWWTjZRcOKExAfI'
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        let currentUser = null;
        let userProfile = null;
        let batchId = null;
        let attendanceDate = null;
        
        // Find URL parameters (batchId and date)
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            batchId = params.get('batchId');
            attendanceDate = params.get('date');
            
            if (!batchId || !attendanceDate) {
                alert('Error: Batch ID or Date is missing. Returning to selection page.');
                window.location.href = 'teacher_attendance.html';
                return false;
            }
            return true;
        }
        
        // Fetches necessary data and renders the student list
        async function loadAttendanceData() {
            const studentList = document.getElementById('student-list');
            studentList.innerHTML = '<p class="py-4 px-4 text-center text-gray-500">Fetching data...</p>';
            
            // Get Batch Name
            try {
                const { data: batchData, error: batchError } = await supabase
                    .from('batches')
                    .select('name')
                    .eq('id', batchId)
                    .single();
                    
                if (batchError) throw batchError;
                document.getElementById('batch-name').textContent = batchData.name;
            } catch (error) {
                document.getElementById('batch-name').textContent = 'ERROR';
                alert('Could not find batch name.');
            }
            
            document.getElementById('attendance-date-display').textContent = attendanceDate;
            
            // 1. Get all students in this batch
            const { data: students, error: studentError } = await supabase
                .from('students')
                .select('id, full_name')
                .eq('batch_id', batchId)
                .order('full_name', { ascending: true });
                
            if (studentError) {
                alert('Error fetching students: ' + studentError.message);
                studentList.innerHTML = '<p class="py-4 px-4 text-center text-red-500">Error loading students.</p>';
                return;
            }
            
            // 2. Get today's attendance records that *already exist*
            const { data: attendanceRecords } = await supabase
                .from('attendance')
                .select('student_id, status')
                .eq('batch_id', batchId)
                .eq('date', attendanceDate);
            
            const statusMap = new Map();
            if (attendanceRecords) {
                attendanceRecords.forEach(record => {
                    statusMap.set(record.student_id, record.status);
                });
            }

            studentList.innerHTML = '';
            let isEditing = attendanceRecords && attendanceRecords.length > 0;
            document.getElementById('status-message').textContent = isEditing ? 'Editing previously saved attendance.' : 'Marking new attendance.';

            if (students.length === 0) {
                 studentList.innerHTML = '<p class="py-4 px-4 text-center text-gray-500">No students found in this batch.</p>';
                 return;
            }

            // 3. Render the new "card" list
            students.forEach(student => {
                const card = document.createElement('div');
                card.className = "bg-white rounded-lg shadow p-4"; // Mobile-friendly card
                
                const savedStatus = statusMap.get(student.id) || 'present'; // Default to 'present'
                const radioName = `status-${student.id}`;

                const isPresent = savedStatus === 'present' ? 'checked' : '';
                const isAbsent = savedStatus === 'absent' ? 'checked' : '';
                const isLate = savedStatus === 'late' ? 'checked' : '';
                const isExcused = savedStatus === 'excused' ? 'checked' : '';
                
                // NEW: This is the card template
                card.innerHTML = `
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <p class="text-lg font-medium text-gray-900 mb-3 sm:mb-0">
                            ${student.full_name}
                        </p>
                        
                        <div class="w-full sm:w-auto sm:max-w-xs">
                            <div class="flex attendance-btn-group" role="radiogroup">
                                <input type="radio" id="${radioName}-p" name="${radioName}" value="present" ${isPresent} data-student-id="${student.id}">
                                <label for="${radioName}-p" class="attendance-btn btn-present">Present</label>
                                
                                <input type="radio" id="${radioName}-a" name="${radioName}" value="absent" ${isAbsent} data-student-id="${student.id}">
                                <label for="${radioName}-a" class="attendance-btn btn-absent">Absent</label>
                                
                                <input type="radio" id="${radioName}-l" name="${radioName}" value="late" ${isLate} data-student-id="${student.id}">
                                <label for="${radioName}-l" class="attendance-btn btn-late">Late</label>
                                
                                <input type="radio" id="${radioName}-e" name="${radioName}" value="excused" ${isExcused} data-student-id="${student.id}">
                                <label for="${radioName}-e" class="attendance-btn btn-excused">Excused</label>
                            </div>
                        </div>
                    </div>
                `;
                studentList.appendChild(card);
            });
        }
        
        async function saveAttendance() {
            const saveButton = document.getElementById('save-attendance-button');
            saveButton.textContent = 'Saving...';
            saveButton.disabled = true;

            const studentList = document.getElementById('student-list');
            const allRadioButtons = studentList.querySelectorAll('input[type="radio"]:checked');
            
            const recordsToUpsert = [];
            
            allRadioButtons.forEach(radio => {
                recordsToUpsert.push({
                    student_id: radio.dataset.studentId,
                    batch_id: batchId,
                    date: attendanceDate,
                    status: radio.value,
                    teacher_id: currentUser.id,
                    institute_id: userProfile.institute_id
                });
            });

            if (recordsToUpsert.length === 0) {
                alert('No students to save.');
                saveButton.textContent = 'Save Attendance';
                saveButton.disabled = false;
                return;
            }

            const { error } = await supabase
                .from('attendance')
                .upsert(recordsToUpsert, { onConflict: 'student_id, batch_id, date' });

            if (error) {
                console.error('Error saving attendance:', error);
                alert('Error: ' + error.message);
            } else {
                alert('Attendance saved successfully!');
                // Go back to the selector page after saving
                window.location.href = 'teacher_attendance.html';
            }
            
            saveButton.textContent = 'Save Attendance';
            saveButton.disabled = false;
        }

        // --- REAL AUTH CHECK ---
        async function checkAuth() {
            // First, check if we have the needed URL params
            if (!getUrlParams()) return; // This will redirect if params are missing

            // Now, do the full user auth check
            const resp = await supabase.auth.getSession()
            const data = resp?.data ?? null
            const session = data?.session ?? null
            const sessionError = resp?.error ?? null

            if (sessionError || !session) {
                window.location.href = 'teacher_login.html'
                return
            }
            currentUser = session.user

            const { data: profile, error: profileError } = await supabase
                .from('profiles')
                .select('role, institute_id, is_active, can_manage_attendance')
                .eq('id', currentUser.id)
                .single()

            if (profileError || !profile) {
                try { await supabase.auth.signOut() } catch (e) { /* ignore */ }
                window.location.href = 'teacher_login.html'
                return
            }
            userProfile = profile

            if (profile.role !== 'teacher' || !profile.is_active) {
                alert('You are not an active teacher. Please contact your admin.')
                try { await supabase.auth.signOut() } catch (e) { /* ignore */ }
                window.location.href = 'teacher_login.html'
                return
            }
            
            // PERMISSION CHECK
            if (!userProfile.can_manage_attendance) {
                 alert('You do not have permission to manage attendance. Redirecting...');
                 window.location.href = 'teacher_dashboard.html'; // or wherever is safe
                 return;
            }

            // If all checks pass, run the page logic
            document.getElementById('save-attendance-button').addEventListener('click', saveAttendance);
            loadAttendanceData();
        }
        
        checkAuth(); // Start the app
    </script>
</body>
</html>
