<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark Attendance - ERPLI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* All CSS is in this file */
        body { font-family: "Inter", sans-serif; background-color: #F9FAFB; color: #1F2937; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .form-submit-button { display: flex; justify-content: center; align-items: center; gap: 0.5rem; background-color: #3B82F6; color: #ffffff; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.2s ease; }
        .form-submit-button:hover { background-color: #2563EB; }
        .form-submit-button:disabled { background-color: #9CA3AF; cursor: not-allowed; }

        /* Attendance Button Group */
        .attendance-btn-group { display: flex; border-radius: 0.375rem; overflow: hidden; }
        .attendance-btn-group input[type="radio"] { display: none; }
        .attendance-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #D1D5DB;
            color: #4B5563;
            font-weight: 500;
            font-size: 0.75rem;
            cursor: pointer;
            flex-grow: 1;
            text-align: center;
            transition: all 0.2s ease;
        }
        .attendance-btn:not(:first-child) { border-left-width: 0; }

        /* Present */
        .attendance-btn-group input[type="radio"]:checked + .attendance-btn.btn-present { background-color: #16A34A; color: white; border-color: #16A34A; }
        /* Absent */
        .attendance-btn-group input[type="radio"]:checked + .attendance-btn.btn-absent { background-color: #DC2626; color: white; border-color: #DC2626; }
        /* Late */
        .attendance-btn-group input[type="radio"]:checked + .attendance-btn.btn-late { background-color: #F59E0B; color: white; border-color: #F59E0B; }
        /* Excused */
        .attendance-btn-group input[type="radio"]:checked + .attendance-btn.btn-excused { background-color: #6B7280; color: white; border-color: #6B7280; }
    </style>
</head>
<body class="bg-gray-50">

    <main class="max-w-4xl mx-auto p-4 md:p-8">
        
        <div class="flex items-center gap-4 mb-6">
            <a href="teacher_attendance.html" class="flex items-center justify-center p-2 rounded-lg text-gray-500 hover:bg-gray-100 hover:text-gray-900">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </a>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Mark Attendance</h1>
        </div>

        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-2">Batch: <span id="batch-name">...</span></h2>
            <p class="text-sm text-gray-600">Date: <span id="attendance-date-display">...</span></p>
            <p id="status-message" class="text-sm font-medium mt-2 text-blue-600"></p>
        </div>

        <div class="w-full overflow-x-auto bg-white rounded-lg shadow-md">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>
                        <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Set Status</th>
                    </tr>
                </thead>
                <tbody id="student-list" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="2" class="py-4 px-4 text-center text-gray-500">Loading students...</td></tr>
                </tbody>
            </table>
        </div>
        
        <button id="save-attendance-button" class="form-submit-button w-full mt-6">
            Save Attendance
        </button>
        
    </main>


    <script type="module">
        // 1. Import the Supabase library
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        // 2. Add your Supabase keys here
        const SUPABASE_URL = 'https://mclizdhmmzckhjnocktz.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jbGl6ZGhtbXpja2hqbm9ja3R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNDk5MzUsImV4cCI6MjA3NzgyNTkzNX0.zKvs2XDOvcJfb_mCDHOMsJwRKvUViWWTjZRcOKExAfI'
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // Global variables
        let currentUser = null;
        let userProfile = null;
        let batchId = null;
        let attendanceDate = null;

        // --- 3. CORE LOGIC ---
        
        // Find URL parameters (batchId and date)
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            batchId = params.get('batchId');
            attendanceDate = params.get('date');
            
            if (!batchId || !attendanceDate) {
                alert('Error: Batch ID or Date is missing. Returning to selection page.');
                window.location.href = 'teacher_attendance.html';
                return false;
            }
            return true;
        }
        
        // Fetches necessary data and renders the student list
        async function loadAttendanceData() {
            const studentList = document.getElementById('student-list');
            studentList.innerHTML = '<tr><td colspan="2" class="py-4 px-4 text-center text-gray-500">Fetching data...</td></tr>';
            
            // Get Batch Name
            const { data: batchData, error: batchError } = await supabase
                .from('batches')
                .select('name')
                .eq('id', batchId)
                .single();
                
            if (batchError) {
                 document.getElementById('batch-name').textContent = 'ERROR';
                 alert('Could not find batch name.');
            } else {
                 document.getElementById('batch-name').textContent = batchData.name;
            }
            
            document.getElementById('attendance-date-display').textContent = attendanceDate;
            
            // 1. Get all students in this batch (Security is handled by RLS on 'students' table)
            const { data: students, error: studentError } = await supabase
                .from('students')
                .select('id, full_name')
                .eq('batch_id', batchId)
                .order('full_name', { ascending: true });
                
            if (studentError) {
                alert('Error fetching students: ' + studentError.message);
                studentList.innerHTML = '<tr><td colspan="2" class="py-4 px-4 text-center text-red-500">Error loading students.</td></tr>';
                return;
            }
            
            // 2. Get today's attendance records that *already exist*
            const { data: attendanceRecords } = await supabase
                .from('attendance')
                .select('student_id, status')
                .eq('batch_id', batchId)
                .eq('date', attendanceDate);
            
            // Create map for easy lookup
            const statusMap = new Map();
            if (attendanceRecords) {
                attendanceRecords.forEach(record => {
                    statusMap.set(record.student_id, record.status);
                });
            }

            // Render the list
            studentList.innerHTML = '';
            let isEditing = attendanceRecords && attendanceRecords.length > 0;
            document.getElementById('status-message').textContent = isEditing ? 'Editing previously saved attendance.' : 'Marking new attendance.';

            students.forEach(student => {
                const row = document.createElement('tr');
                const savedStatus = statusMap.get(student.id) || 'present'; // Default to 'present'
                const radioName = `status-${student.id}`;

                const isPresent = savedStatus === 'present' ? 'checked' : '';
                const isAbsent = savedStatus === 'absent' ? 'checked' : '';
                const isLate = savedStatus === 'late' ? 'checked' : '';
                const isExcused = savedStatus === 'excused' ? 'checked' : '';
                
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm font-medium text-gray-900">${student.full_name}</td>
                    <td class="py-3 px-4 text-sm">
                        <div class="flex attendance-btn-group" role="radiogroup">
                            <input type="radio" id="${radioName}-p" name="${radioName}" value="present" ${isPresent} data-student-id="${student.id}">
                            <label for="${radioName}-p" class="attendance-btn btn-present">Present</label>
                            
                            <input type="radio" id="${radioName}-a" name="${radioName}" value="absent" ${isAbsent} data-student-id="${student.id}">
                            <label for="${radioName}-a" class="attendance-btn btn-absent">Absent</label>
                            
                            <input type="radio" id="${radioName}-l" name="${radioName}" value="late" ${isLate} data-student-id="${student.id}">
                            <label for="${radioName}-l" class="attendance-btn btn-late">Late</label>
                            
                            <input type="radio" id="${radioName}-e" name="${radioName}" value="excused" ${isExcused} data-student-id="${student.id}">
                            <label for="${radioName}-e" class="attendance-btn btn-excused">Excused</label>
                        </div>
                    </td>
                `;
                studentList.appendChild(row);
            });
        }
        
        // Save the attendance data
        async function saveAttendance() {
            const saveButton = document.getElementById('save-attendance-button');
            saveButton.textContent = 'Saving...';
            saveButton.disabled = true;

            const studentList = document.getElementById('student-list');
            const allRadioButtons = studentList.querySelectorAll('input[type="radio"]:checked');
            
            const recordsToUpsert = []; // 'Upsert' = Update if exists, Insert if new
            
            allRadioButtons.forEach(radio => {
                recordsToUpsert.push({
                    student_id: radio.dataset.studentId,
                    batch_id: batchId,
                    date: attendanceDate,
                    status: radio.value,
                    teacher_id: currentUser.id,
                    institute_id: userProfile.institute_id
                });
            });

            if (recordsToUpsert.length === 0) {
                alert('No students to save.');
                saveButton.textContent = 'Save Attendance';
                saveButton.disabled = false;
                return;
            }

            // Use 'upsert' to save. This is powerful.
            const { error } = await supabase
                .from('attendance')
                .upsert(recordsToUpsert, { onConflict: 'student_id, batch_id, date' });

            if (error) {
                console.error('Error saving attendance:', error);
                alert('Error: ' + error.message);
            } else {
                alert('Attendance saved successfully!');
            }
            
            saveButton.textContent = 'Save Attendance';
            saveButton.disabled = false;
        }


        // --- 4. STARTUP FUNCTIONS ---
        async function checkAuth() {
            // (Security check logic removed for brevity, assuming it sends userProfile)
            // For this file, we ONLY check the URL params first.
            if (!getUrlParams()) return;
            
            // Assume Auth check passes and sets userProfile and currentUser
            // You must copy the checkAuth function from teacher_attendance.html here!
            
            // HACK: Assuming you copied the full checkAuth here and it passed:
            // if (!window.currentUser || window.userProfile.role !== 'teacher') return;
            
            // FOR TESTING ONLY (Replace with real checkAuth when merging files)
            const fakeProfile = { full_name: 'Test Teacher', institute_id: 'a4dfdcf2-4978-4b2e-a5e4-f6939ef18ba7', role: 'teacher' };
            window.currentUser = { id: 'some-teacher-id' };
            window.userProfile = fakeProfile;
            
            document.getElementById('save-attendance-button').addEventListener('click', saveAttendance);
            loadAttendanceData();
        }
        
        // This file needs a full Auth check like all others to work
        checkAuth();
    </script>
</body>
</html>