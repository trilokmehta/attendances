<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Student - ERPLI</title>
    
    <!-- 1. We load Tailwind CSS from a CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 
      START CSS
      All CSS for this page is right here.
    -->
    <style>
        /* Custom Global Styles (Light Theme) */
        body { font-family: "Inter", sans-serif; background-color: #F9FAFB; color: #1F2937; }
        #sidebar-overlay { display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 40; transition: opacity 0.3s ease; }
        /* Sidebar for Teacher */
        #teacher-sidebar {
            width: 16rem; /* 256px */
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 50;
            display: flex;
            flex-direction: column;
            background-color: #ffffff; /* white */
            border-right: 1px solid #E5E7EB; /* gray-200 */
            transform: translateX(-100%);
            transition: transform 0.3s ease, width 0.3s ease;
        }
        #main-content-wrapper { width: 100%; padding-top: 4rem; transition: margin-left 0.3s ease; }
        #mobile-header { position: sticky; top: 0; height: 4rem; background-color: #ffffff; border-bottom: 1px solid #E5E7EB; z-index: 30; }
        
        @media (min-width: 768px) {
            #teacher-sidebar { transform: translateX(0); }
            #mobile-header { display: none; }
            #main-content-wrapper { margin-left: 16rem; width: calc(100% - 16rem); padding-top: 0; }
        }
        
        /* Retraction is simpler, just hide text */
        body.sidebar-retracted #teacher-sidebar { width: 5rem; }
        @media (min-width: 768px) {
            body.sidebar-retracted #main-content-wrapper { margin-left: 5rem; width: calc(100% - 5rem); }
        }
        body.sidebar-retracted .sidebar-text { display: none; }
        body.sidebar-retracted .nav-link, body.sidebar-retracted #logout-button { justify-content: center; gap: 0; }
        body.sidebar-retracted #sidebar-toggle-button svg { transform: rotate(180deg); }
        
        /* Mobile Menu */
        body.sidebar-mobile-open #teacher-sidebar { transform: translateX(0); }
        body.sidebar-mobile-open #sidebar-overlay { display: block; opacity: 1; }
        body.sidebar-mobile-open #main-content-wrapper { display: none; }
        
        /* Component Styles */
        .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 500; color: #4B5563; transition: all 0.2s ease; white-space: nowrap; overflow: hidden; }
        .nav-link:hover { background-color: #F3F4F6; color: #111827; }
        .nav-link.active { background-color: #3B82F6; color: #ffffff; }
        .nav-link.active .nav-icon { color: #ffffff; }
        
        /* Page-specific styles */
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            border: 1px solid #D1D5DB; /* gray-300 */
            border-radius: 0.5rem; /* 8px */
            padding: 0.75rem 1rem; /* 12px 16px */
            color: #111827; /* gray-900 */
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #3B82F6; box-shadow: 0 0 0 2px #BFDBFE; }
        .form-input:disabled, .form-select:disabled, .form-textarea:disabled {
            background-color: #F3F4F6;
            cursor: not-allowed;
        }
        .form-submit-button { display: flex; justify-content: center; align-items: center; gap: 0.5rem; background-color: #3B82F6; color: #ffffff; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.2s ease; }
        .form-submit-button:hover { background-color: #2563EB; }
        .form-submit-button:disabled { background-color: #9CA3AF; cursor: not-allowed; }
    </style>
</head>
<body class="page-container">

    <!-- 
      START SIDEBAR HTML (Teacher Version)
    -->
    <aside id="teacher-sidebar">
        <!-- Sidebar content -->
        <div class="flex h-full flex-col overflow-y-auto">
            <!-- Sidebar Header -->
            <div class="flex h-16 items-center justify-between border-b border-gray-200 px-4 flex-shrink-0">
                <span class="sidebar-text text-xl font-bold text-gray-900">Teacher Portal</span>
                <button id="sidebar-toggle-button" class="hidden md:block p-2 rounded-md hover:bg-gray-100 text-gray-500 hover:text-gray-900">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
            </div>

            <!-- Navigation Links -->
            <nav id="sidebar-nav" class="flex-1 space-y-2 p-4">
                <a href="teacher_dashboard.html" data-page="teacher_dashboard" class="nav-link">
                    <svg class="h-6 w-6 nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4h.01M12 12h.01M15 12h.01M9 12h.01M12 15h.01M15 15h.01M9 15h.01" /></svg>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                
                <a id="nav-attendance" href="teacher_attendance.html" data-page="teacher_attendance" class="nav-link" style="display: none;">
                    <svg class="h-6 w-6 nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                    <span class="sidebar-text">Take Attendance</span>
                </a>

                <a id="nav-fees" href="teacher_fees.html" data-page="teacher_fees" class="nav-link" style="display: none;">
                    <svg class="h-6 w-6 nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    <span class="sidebar-text">Log Fee Payment</span>
                </a>

                <a id="nav-students" href="teacher_add_student.html" data-page="teacher_add_student" class="nav-link" style="display: none;">
                    <svg class="h-6 w-6 nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>
                    <span class="sidebar-text">Add New Student</span>
                </a>
            </nav>
            
            <!-- Logout Footer -->
            <div class="border-t border-gray-200 p-4 flex-shrink-0">
                <div id="user-info" class="mb-2 overflow-hidden">
                    <span class="sidebar-text block text-sm font-medium text-gray-700 truncate" id="user-email-sidebar">Loading...</span>
                    <span class="sidebar-text block text-xs text-gray-500" id="user-role-sidebar">Teacher</span>
                </div>
                <button id="logout-button" class="w-full flex items-center justify-center gap-2 rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-700">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    <span class="sidebar-text">Logout</span>
                </button>
            </div>
        </div>
    </aside>
    <!-- END SIDEBAR HTML -->

    <!-- Overlay for mobile sidebar -->
    <div id="sidebar-overlay"></div>
    
    
    <!-- 
      START MAIN CONTENT WRAPPER
    -->
    <div id="main-content-wrapper">
        
        <!-- Mobile-Only Header -->
        <header id="mobile-header" class="md:hidden flex items-center justify-between px-4">
            <span class="text-xl font-bold text-gray-900">Teacher Portal</span>
            <button id="mobile-menu-button" class="p-2 rounded-md text-gray-500 hover:text-gray-900 hover:bg-gray-100">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
        </header>

        <!-- 
          START PAGE-SPECIFIC CONTENT
        -->
        <main class="p-4 md:p-8">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">Add New Student</h1>
            
            <!-- This message shows if they don't have permission -->
            <div id="permission-denied" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                <strong class="font-bold">Access Denied!</strong>
                <span class="block sm:inline">You do not have permission to add new students. Please contact your admin.</span>
            </div>
            
            <!-- This is the main content, hidden until permissions are checked -->
            <div id="add-student-content" class="hidden">
                <form id="add-student-form" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- Personal Details -->
                        <div class="md:col-span-2">
                            <h3 class="text-lg font-medium text-gray-900">Student Details</h3>
                        </div>
                        
                        <div>
                            <label for="full_name" class="form-label">Student's Full Name <span class="text-red-500">*</span></label>
                            <input type="text" id="full_name" class="form-input" required>
                        </div>
                        
                        <div>
                            <label for="phone" class="form-label">Student's Phone <span class="text-red-500">*</span></label>
                            <input type="tel" id="phone" class="form-input" required>
                        </div>

                        <div>
                            <label for="email" class="form-label">Student's Email</label>
                            <input type="email" id="email" class="form-input" placeholder="student@example.com">
                        </div>

                        <div>
                            <label for="dob" class="form-label">Date of Birth</label>
                            <input type="date" id="dob" class="form-input">
                        </div>

                        <!-- Academic Details -->
                        <div class="md:col-span-2 border-t pt-6 mt-2">
                            <h3 class="text-lg font-medium text-gray-900">Academic & Fee Details</h3>
                        </div>

                        <div>
                            <label for="batch-select" class="form-label">Assign to Batch <span class="text-red-500">*</span></label>
                            <select id="batch-select" class="form-select" required>
                                <option value="">Loading batches...</option>
                            </select>
                        </div>

                        <div>
                            <label for="total-fee-due" class="form-label">Total Fee Due (INR) <span class="text-red-500">*</span></label>
                            <input type="number" id="total-fee-due" class="form-input" required min="0" step="100" placeholder="e.g., 50000">
                        </div>

                        <!-- Parent Details -->
                        <div class="md:col-span-2 border-t pt-6 mt-2">
                            <h3 class="text-lg font-medium text-gray-900">Parent/Guardian Details</h3>
                        </div>

                        <div>
                            <label for="father_name" class="form-label">Father's Name</label>
                            <input type="text" id="father_name" class="form-input">
                        </div>
                        
                        <div>
                            <label for="father_phone" class="form-label">Father's Phone</label>
                            <input type="tel" id="father_phone" class="form-input">
                        </div>

                        <!-- Submit Button -->
                        <div class="md:col-span-2 pt-4">
                            <button type="submit" id="save-student-button" class="form-submit-button w-full md:w-auto">
                                Save New Student
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
        </main>
        <!-- END PAGE-SPECIFIC CONTENT -->
    
    </div>
    <!-- END MAIN CONTENT WRAPPER -->


    <!-- 
      START JAVASCRIPT
      All JavaScript for this page is right here.
    -->
    <script type="module">
        // 1. Import the Supabase library
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        // 2. Add your Supabase keys here
        const SUPABASE_URL = 'https://mclizdhmmzckhjnocktz.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jbGl6ZGhtbXpja2hqbm9ja3R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNDk5MzUsImV4cCI6MjA3NzgyNTkzNX0.zKvs2XDOvcJfb_mCDHOMsJwRKvUViWWTjZRcOKExAfI'
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // We will store the user and profile globally on the page
        let currentUser = null;
        let userProfile = null;


        // --- 3. THE SECURITY GUARD ---
        async function checkAuth() {
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            if (sessionError || !session) {
                window.location.href = 'index.html';
                return;
            }
            currentUser = session.user;
            
            const { data: profile, error: profileError } = await supabase
                .from('profiles')
                .select('role, institute_id, full_name, is_active, can_manage_attendance, can_manage_fees, can_add_students')
                .eq('id', currentUser.id)
                .single();
                
            if (profileError) {
                await supabase.auth.signOut();
                window.location.href = 'index.html';
                return;
            }
            
            userProfile = profile; 

            if (profile.role !== 'teacher' || !profile.is_active) {
                alert('You are not an active teacher. Please contact your admin.');
                await supabase.auth.signOut();
                window.location.href = 'index.html';
                return;
            }
            
            runPageLogic();
        }

        // --- 4. SIDEBAR & NAVIGATION LOGIC ---
        function setupSidebarAndNav() {
            const logoutButton = document.getElementById('logout-button');
            const userEmailSpan = document.getElementById('user-email-sidebar');
            const desktopToggleButton = document.getElementById('sidebar-toggle-button');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            logoutButton.addEventListener('click', async () => {
                await supabase.auth.signOut();
                window.location.href = 'index.html';
            });

            if (currentUser) {
                userEmailSpan.textContent = currentUser.email;
            }

            // --- THIS IS THE ONLY LINE TO CHANGE ---
            const currentPage = "teacher_add_student";
            // ------------------------------------

            const navLinks = document.querySelectorAll("#sidebar-nav a");
            navLinks.forEach(link => {
                if (link.getAttribute("data-page") === currentPage) {
                    link.classList.add("active");
                }
            });

            desktopToggleButton.addEventListener('click', () => {
                document.body.classList.toggle('sidebar-retracted');
            });
            mobileMenuButton.addEventListener('click', () => {
                document.body.classList.add('sidebar-mobile-open');
            });
            sidebarOverlay.addEventListener('click', () => {
                document.body.classList.remove('sidebar-mobile-open');
            });

            if (userProfile?.can_manage_attendance) {
                document.getElementById('nav-attendance').style.display = 'flex';
            }
            if (userProfile?.can_manage_fees) {
                document.getElementById('nav-fees').style.display = 'flex';
            }
            if (userProfile?.can_add_students) {
                document.getElementById('nav-students').style.display = 'flex';
            }
        }
        
        // --- 5. PAGE-SPECIFIC LOGIC (FOR ADDING STUDENT) ---

        // Get page elements
        const permissionDeniedEl = document.getElementById('permission-denied');
        const addStudentContentEl = document.getElementById('add-student-content');
        const studentForm = document.getElementById('add-student-form');
        const saveButton = document.getElementById('save-student-button');
        
        // Form fields
        const nameInput = document.getElementById('full_name');
        const phoneInput = document.getElementById('phone');
        const emailInput = document.getElementById('email');
        const dobInput = document.getElementById('dob');
        const batchSelect = document.getElementById('batch-select');
        const totalFeeInput = document.getElementById('total-fee-due');
        const fatherNameInput = document.getElementById('father_name');
        const fatherPhoneInput = document.getElementById('father_phone');

        async function fetchAllBatches() {
            if (!userProfile) {
                batchSelect.innerHTML = '<option value="">Unable to load batches</option>';
                return;
            }

            // Fetch ALL batches in the institute
            const { data: batches, error } = await supabase
                .from('batches')
                .select('id, name')
                .eq('institute_id', userProfile.institute_id)
                .order('name', { ascending: true });

            if (error) {
                batchSelect.innerHTML = `<option value="">Error: ${error.message}</option>`;
                return;
            }
            if (!batches?.length) {
                batchSelect.innerHTML = '<option value="">No batches found. Please create one in Admin portal.</option>';
                return;
            }

            batchSelect.innerHTML = '<option value="">Select a batch</option>';
            for (const b of batches) {
                const opt = document.createElement('option');
                opt.value = b.id;
                opt.textContent = b.name;
                batchSelect.appendChild(opt);
            }
        }

        async function saveNewStudent(e) {
            e.preventDefault();
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';

            // 1. Get all values from the form
            const studentData = {
                full_name: nameInput.value,
                phone: phoneInput.value,
                email: emailInput.value || null,
                date_of_birth: dobInput.value || null,
                batch_id: batchSelect.value,
                total_fee_due: parseFloat(totalFeeInput.value),
                father_name: fatherNameInput.value || null,
                father_phone: fatherPhoneInput.value || null,
                
                // Add the required foreign keys
                institute_id: userProfile.institute_id
                
                // mother_name, mother_phone will be null by default
            };

            // 2. Validation
            if (!studentData.full_name || !studentData.phone || !studentData.batch_id || isNaN(studentData.total_fee_due)) {
                alert('Please fill in all required fields: Name, Phone, Batch, and Total Fee.');
                saveButton.disabled = false;
                saveButton.textContent = 'Save New Student';
                return;
            }

            // 3. Insert into Supabase
            const { error } = await supabase
                .from('students')
                .insert(studentData);

            if (error) {
                console.error('Error saving student:', error);
                alert(`Error: ${error.message}`);
            } else {
                alert('New student added successfully!');
                studentForm.reset();
                // Reset batch dropdown
                batchSelect.innerHTML = '<option value="">Loading batches...</option>';
                fetchAllBatches();
            }

            saveButton.disabled = false;
            saveButton.textContent = 'Save New Student';
        }

        function runPageLogic() {
            setupSidebarAndNav();
            
            // 1. Check permission
            if (!userProfile?.can_add_students) {
                permissionDeniedEl.style.display = 'block';
                return;
            }
            
            addStudentContentEl.style.display = 'block';

            // 2. Load initial data
            fetchAllBatches(); 

            // 3. Set up event listeners
            studentForm.addEventListener('submit', saveNewStudent);
        }

        // --- 6. START THE APP ---
        checkAuth();
        
    </script>
</body>
</html>