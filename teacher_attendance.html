<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Attendance - ERPLI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* All styles copied from your file */
        body { font-family: "Inter", sans-serif; background-color: #F9FAFB; color: #1F2937; }
        #sidebar-overlay { display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 40; transition: opacity 0.3s ease; }
        #teacher-sidebar { width: 16rem; height: 100vh; position: fixed; left: 0; top: 0; bottom: 0; z-index: 50; display: flex; flex-direction: column; background-color: #ffffff; border-right: 1px solid #E5E7EB; transform: translateX(-100%); transition: transform 0.3s ease, width 0.3s ease; }
        #main-content-wrapper { width: 100%; padding-top: 4rem; transition: margin-left 0.3s ease; }
        #mobile-header { position: sticky; top: 0; height: 4rem; background-color: #ffffff; border-bottom: 1px solid #E5E7EB; z-index: 30; }
        @media (min-width: 768px) {
            #teacher-sidebar { transform: translateX(0); }
            #mobile-header { display: none; }
            #main-content-wrapper { margin-left: 16rem; width: calc(100% - 16rem); padding-top: 0; }
        }
        body.sidebar-retracted #teacher-sidebar { width: 5rem; }
        @media (min-width: 768px) {
            body.sidebar-retracted #main-content-wrapper { margin-left: 5rem; width: calc(100% - 5rem); }
        }
        body.sidebar-retracted .sidebar-text { display: none; }
        body.sidebar-retracted .nav-link, body.sidebar-retracted #logout-button { justify-content: center; gap: 0; }
        body.sidebar-retracted #sidebar-toggle-button svg { transform: rotate(180deg); }
        body.sidebar-mobile-open #teacher-sidebar { transform: translateX(0); }
        body.sidebar-mobile-open #sidebar-overlay { display: block; opacity: 1; }
        body.sidebar-mobile-open #main-content-wrapper { display: none; }
        .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 500; color: #4B5563; transition: all 0.2s ease; white-space: nowrap; overflow: hidden; }
        .nav-link:hover { background-color: #F3F4F6; color: #111827; }
        .nav-link.active { background-color: #3B82F6; color: #ffffff; }
        .nav-link.active .nav-icon { color: #ffffff; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .form-input, .form-select { width: 100%; border: 1px solid #D1D5DB; border-radius: 0.5rem; padding: 0.75rem 1rem; color: #111827; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #3B82F6; box-shadow: 0 0 0 2px #BFDBFE; }
        .form-submit-button { display: flex; justify-content: center; align-items: center; gap: 0.5rem; background-color: #3B82F6; color: #ffffff; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.2s ease; }
        .form-submit-button:hover { background-color: #2563EB; }
        .form-submit-button:disabled { background-color: #9CA3AF; cursor: not-allowed; }
    </style>
</head>
<body class="page-container">

    <aside id="teacher-sidebar">
        <div class="flex h-full flex-col overflow-y-auto">
            <div class="flex h-16 items-center justify-between border-b border-gray-200 px-4 flex-shrink-0">
                <span class="sidebar-text text-xl font-bold text-gray-900">Teacher Portal</span>
                <button id="sidebar-toggle-button" class="hidden md:block p-2 rounded-md hover:bg-gray-100 text-gray-500 hover:text-gray-900">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
            </div>
            <nav id="sidebar-nav" class="flex-1 space-y-2 p-4">
                <a href="teacher_dashboard.html" data-page="teacher_dashboard" class="nav-link">
                    <svg class="h-6 w-6 nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4h.01M12 12h.01M15 12h.01M9 12h.01M12 15h.01M15 15h.01M9 15h.01" /></svg>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                <a id="nav-attendance" href="teacher_attendance.html" data-page="teacher_attendance" class="nav-link" style="display: none;">
                    <svg class="h-6 w-6 nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                    <span class="sidebar-text">Take Attendance</span>
                </a>
                <a id="nav-fees" href="teacher_fees.html" data-page="teacher_fees" class="nav-link" style="display: none;">
                    <svg class="h-6 w-6 nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    <span class="sidebar-text">Log Fee Payment</span>
                </a>
                <a id="nav-students" href="teacher_add_student.html" data-page="teacher_add_student" class="nav-link" style="display: none;">
                    <svg class="h-6 w-6 nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>
                    <span class="sidebar-text">Add New Student</span>
                </a>
            </nav>
            <div class="border-t border-gray-200 p-4 flex-shrink-0">
                <div id="user-info" class="mb-2 overflow-hidden">
                    <span class="sidebar-text block text-sm font-medium text-gray-700 truncate" id="user-email-sidebar">Loading...</span>
                    <span class="sidebar-text block text-xs text-gray-500" id="user-role-sidebar">Teacher</span>
                </div>
                <button id="logout-button" class="w-full flex items-center justify-center gap-2 rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-700">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    <span class="sidebar-text">Logout</span>
                </button>
            </div>
        </div>
    </aside>
    <div id="sidebar-overlay"></div>
    
    <div id="main-content-wrapper">
        <header id="mobile-header" class="md:hidden flex items-center justify-between px-4">
            <span class="text-xl font-bold text-gray-900">Teacher Portal</span>
            <button id="mobile-menu-button" class="p-2 rounded-md text-gray-500 hover:text-gray-900 hover:bg-gray-100">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
        </header>

        <main class="p-4 md:p-8">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">Take Attendance</h1>
            
            <div id="permission-denied" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                <strong class="font-bold">Access Denied!</strong>
                <span class="block sm:inline">You do not have permission to take attendance. Please contact your admin.</span>
            </div>
            
            <div id="attendance-content" class="hidden">
                <form id="selector-form">
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="batch-select" class="form-label">Select Your Batch</label>
                            <select id="batch-select" class="form-select" required>
                                <option value="">Loading your batches...</option>
                            </select>
                        </div>
                        <div>
                            <label for="attendance-date" class="form-label">Select Date</label>
                            <input type="date" id="attendance-date" class="form-input" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="form-submit-button w-full">
                        Start Attendance
                    </button>
                </form>
            </div>
        </main>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        const SUPABASE_URL = 'https://mclizdhmmzckhjnocktz.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jbGl6ZGhtbXpja2hqbm9ja3R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNDk5MzUsImV4cCI6MjA3NzgyNTkzNX0.zKvs2XDOvcJfb_mCDHOMsJwRKvUViWWTjZRcOKExAfI'

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        let currentUser = null
        let userProfile = null

        async function checkAuth() {
            const resp = await supabase.auth.getSession()
            const data = resp?.data ?? null
            const session = data?.session ?? null
            const sessionError = resp?.error ?? null

            if (sessionError || !session) {
                window.location.href = 'teacher_login.html'
                return
            }

            currentUser = session.user

            const { data: profile, error: profileError } = await supabase
                .from('profiles')
                .select('role, institute_id, full_name, is_active, can_manage_attendance, can_manage_fees, can_add_students')
                .eq('id', currentUser.id)
                .single()

            if (profileError || !profile) {
                try { await supabase.auth.signOut() } catch (e) { /* ignore */ }
                window.location.href = 'teacher_login.html'
                return
            }
            userProfile = profile
            if (typeof profile.role === 'undefined' || typeof profile.is_active === 'undefined') {
                try { await supabase.auth.signOut() } catch (e) { /* ignore */ }
                window.location.href = 'teacher_login.html'
                return
            }
            if (profile.role !== 'teacher' || !profile.is_active) {
                alert('You are not an active teacher. Please contact your admin.')
                try { await supabase.auth.signOut() } catch (e) { /* ignore */ }
                window.location.href = 'teacher_login.html'
                return
            }

            runPageLogic()
        }

        function setupSidebarAndNav() {
            const logoutButton = document.getElementById('logout-button')
            const userEmailSpan = document.getElementById('user-email-sidebar')
            const desktopToggleButton = document.getElementById('sidebar-toggle-button')
            const mobileMenuButton = document.getElementById('mobile-menu-button')
            const sidebarOverlay = document.getElementById('sidebar-overlay')

            if (logoutButton) {
                logoutButton.addEventListener('click', async () => {
                    await supabase.auth.signOut()
                    window.location.href = 'teacher_login.html'
                })
            }
            if (userEmailSpan && currentUser) {
                userEmailSpan.textContent = currentUser.email ?? ''
            }
            const currentPage = "teacher_attendance"
            const navLinks = document.querySelectorAll('#sidebar-nav a')
            navLinks.forEach(link => {
                if (link.getAttribute('data-page') === currentPage) {
                    link.classList.add('active')
                }
            })
            if (desktopToggleButton) {
                desktopToggleButton.addEventListener('click', () => {
                    document.body.classList.toggle('sidebar-retracted')
                })
            }
            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', () => {
                    document.body.classList.add('sidebar-mobile-open')
                })
            }
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', () => {
                    document.body.classList.remove('sidebar-mobile-open')
                })
            }
            if (userProfile?.can_manage_attendance) {
                const el = document.getElementById('nav-attendance')
                if (el) el.style.display = 'flex'
            }
            if (userProfile?.can_manage_fees) {
                const el = document.getElementById('nav-fees')
                if (el) el.style.display = 'flex'
            }
            if (userProfile?.can_add_students) {
                const el = document.getElementById('nav-students')
                if (el) el.style.display = 'flex'
            }
        }

        const permissionDeniedEl = document.getElementById('permission-denied')
        const attendanceContentEl = document.getElementById('attendance-content')
        const batchSelect = document.getElementById('batch-select')
        const dateSelect = document.getElementById('attendance-date')
        const selectorForm = document.getElementById('selector-form')

        function getValidDates() {
            const today = new Date()
            const yesterday = new Date(today)
            yesterday.setDate(yesterday.getDate() - 1)
            const todayStr = today.toISOString().split('T')[0]
            const yesterdayStr = yesterday.toISOString().split('T')[0]
            return { today: todayStr, yesterday: yesterdayStr }
        }

        async function fetchAssignedBatches() {
            if (!currentUser || !userProfile) {
                batchSelect.innerHTML = '<option value="">Unable to load batches</option>'
                return
            }
            const { data: assignments, error: assignErr } = await supabase
                .from('batch_teachers')
                .select('batch_id')
                .eq('teacher_id', currentUser.id)
                .eq('institute_id', userProfile.institute_id)
            if (assignErr) {
                console.error('Error fetching assignments:', assignErr)
                batchSelect.innerHTML = `<option value="">Error: ${assignErr.message}</option>`
                return
            }
            if (!assignments?.length) {
                batchSelect.innerHTML = '<option value="">Admin has not assigned you any batches</option>'
                return
            }
            const batchIds = assignments.map(a => a.batch_id).filter(Boolean)
            const { data: batches, error: batchErr } = await supabase
                .from('batches')
                .select('id, name')
                .in('id', batchIds)
                .eq('institute_id', userProfile.institute_id)
            if (batchErr) {
                console.error('Error fetching batches:', batchErr)
                batchSelect.innerHTML = `<option value="">Error: ${batchErr.message}</option>`
                return
            }
            if (!batches?.length) {
                batchSelect.innerHTML = '<option value="">No batches found in system</bool'
                return
            }
            batchSelect.innerHTML = '<option value="">Select your batch</option>'
            for (const b of batches) {
                const opt = document.createElement('option')
                opt.value = b.id
                opt.textContent = b.name
                batchSelect.appendChild(opt)
            }
        }

        function handleStartAttendance(e) {
            e.preventDefault()
            const batchId = batchSelect?.value ?? ''
            const date = dateSelect?.value ?? ''
            if (!batchId || !date) {
                alert('Please select both a batch and a date.')
                return
            }
            const href = `teacher_take_attendance.html?batchId=${encodeURIComponent(batchId)}&date=${encodeURIComponent(date)}`
            window.location.href = href
        }

        function runPageLogic() {
            setupSidebarAndNav()
            if (!userProfile?.can_manage_attendance) {
                if (permissionDeniedEl) permissionDeniedEl.style.display = 'block'
                return
            }
            if (attendanceContentEl) attendanceContentEl.style.display = 'block'
            const { today, yesterday } = getValidDates()
            if (dateSelect) {
                dateSelect.value = today
                dateSelect.max = today
                dateSelect.min = yesterday // Only allow today and yesterday
            }
            fetchAssignedBatches()
            if (selectorForm) {
                selectorForm.addEventListener('submit', handleStartAttendance)
            }
        }
        checkAuth()
    </script>
</body>
</html>
