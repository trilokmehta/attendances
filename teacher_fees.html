<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Fee Payment - ERPLI</title>
    
    <!-- 1. We load Tailwind CSS from a CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 
      START CSS
      All CSS for this page is right here.
    -->
    <style>
        /* Custom Global Styles (Light Theme) */
        body { font-family: "Inter", sans-serif; background-color: #F9FAFB; color: #1F2937; }
        #sidebar-overlay { display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 40; transition: opacity 0.3s ease; }
        /* Sidebar for Teacher */
        #teacher-sidebar {
            width: 16rem; /* 256px */
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 50;
            display: flex;
            flex-direction: column;
            background-color: #ffffff; /* white */
            border-right: 1px solid #E5E7EB; /* gray-200 */
            transform: translateX(-100%);
            transition: transform 0.3s ease, width 0.3s ease;
        }
        #main-content-wrapper { width: 100%; padding-top: 4rem; transition: margin-left 0.3s ease; }
        #mobile-header { position: sticky; top: 0; height: 4rem; background-color: #ffffff; border-bottom: 1px solid #E5E7EB; z-index: 30; }
        
        @media (min-width: 768px) {
            #teacher-sidebar { transform: translateX(0); }
            #mobile-header { display: none; }
            #main-content-wrapper { margin-left: 16rem; width: calc(100% - 16rem); padding-top: 0; }
        }
        
        /* Retraction is simpler, just hide text */
        body.sidebar-retracted #teacher-sidebar { width: 5rem; }
        @media (min-width: 768px) {
            body.sidebar-retracted #main-content-wrapper { margin-left: 5rem; width: calc(100% - 5rem); }
        }
        body.sidebar-retracted .sidebar-text { display: none; }
        body.sidebar-retracted .nav-link, body.sidebar-retracted #logout-button { justify-content: center; gap: 0; }
        body.sidebar-retracted #sidebar-toggle-button svg { transform: rotate(180deg); }
        
        /* Mobile Menu */
        body.sidebar-mobile-open #teacher-sidebar { transform: translateX(0); }
        body.sidebar-mobile-open #sidebar-overlay { display: block; opacity: 1; }
        body.sidebar-mobile-open #main-content-wrapper { display: none; }
        
        /* Component Styles */
        .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 500; color: #4B5563; transition: all 0.2s ease; white-space: nowrap; overflow: hidden; }
        .nav-link:hover { background-color: #F3F4F6; color: #111827; }
        .nav-link.active { background-color: #3B82F6; color: #ffffff; }
        .nav-link.active .nav-icon { color: #ffffff; }
        
        /* Page-specific styles */
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            border: 1px solid #D1D5DB; /* gray-300 */
            border-radius: 0.5rem; /* 8px */
            padding: 0.75rem 1rem; /* 12px 16px */
            color: #111827; /* gray-900 */
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #3B82F6; box-shadow: 0 0 0 2px #BFDBFE; }
        .form-input:disabled, .form-select:disabled, .form-textarea:disabled {
            background-color: #F3F4F6;
            cursor: not-allowed;
        }
        .form-submit-button { display: flex; justify-content: center; align-items: center; gap: 0.5rem; background-color: #3B82F6; color: #ffffff; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.2s ease; }
        .form-submit-button:hover { background-color: #2563EB; }
        .form-submit-button:disabled { background-color: #9CA3AF; cursor: not-allowed; }

        /* Spinner for loading */
        .spinner {
            width: 2rem; height: 2rem;
            border-radius: 50%;
            border: 4px solid #E5E7EB; /* gray-200 */
            border-top-color: #3B82F6; /* blue-600 */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* NEW: Custom scrollbar for payment history */
        .payment-history-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .payment-history-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .payment-history-scroll::-webkit-scrollbar-thumb {
            background: #D1D5DB; /* gray-300 */
            border-radius: 10px;
        }
        .payment-history-scroll::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF; /* gray-400 */
        }
    </style>
</head>
<body class="page-container">

    <!-- 
      START SIDEBAR HTML (Teacher Version)
    -->
    <aside id="teacher-sidebar">
        <!-- Sidebar content -->
        <div class="flex h-full flex-col overflow-y-auto">
            <!-- Sidebar Header -->
            <div class="flex h-16 items-center justify-between border-b border-gray-200 px-4 flex-shrink-0">
                <span class="sidebar-text text-xl font-bold text-gray-900">Teacher Portal</span>
                <button id="sidebar-toggle-button" class="hidden md:block p-2 rounded-md hover:bg-gray-100 text-gray-500 hover:text-gray-900">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
            </div>

            <!-- Navigation Links -->
            <nav id="sidebar-nav" class="flex-1 space-y-2 p-4">
                <a href="teacher_dashboard.html" data-page="teacher_dashboard" class="nav-link">
                    <svg class="h-6 w-6 nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4h.01M12 12h.01M15 12h.01M9 12h.01M12 15h.01M15 15h.01M9 15h.01" /></svg>
                    <span class="sidebar-text">Dashboard</span>
                </a>
                
                <a id="nav-attendance" href="teacher_attendance.html" data-page="teacher_attendance" class="nav-link" style="display: none;">
                    <svg class="h-6 w-6 nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                    <span class="sidebar-text">Take Attendance</span>
                </a>

                <a id="nav-fees" href="teacher_fees.html" data-page="teacher_fees" class="nav-link" style="display: none;">
                    <svg class="h-6 w-6 nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    <span class="sidebar-text">Log Fee Payment</span>
                </a>

                <a id="nav-students" href="teacher_add_student.html" data-page="teacher_add_student" class="nav-link" style="display: none;">
                    <svg class="h-6 w-6 nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>
                    <span class="sidebar-text">Add New Student</span>
                </a>
            </nav>
            
            <!-- Logout Footer -->
            <div class="border-t border-gray-200 p-4 flex-shrink-0">
                <div id="user-info" class="mb-2 overflow-hidden">
                    <span class="sidebar-text block text-sm font-medium text-gray-700 truncate" id="user-email-sidebar">Loading...</span>
                    <span class="sidebar-text block text-xs text-gray-500" id="user-role-sidebar">Teacher</span>
                </div>
                <button id="logout-button" class="w-full flex items-center justify-center gap-2 rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-700">
                    <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    <span class="sidebar-text">Logout</span>
                </button>
            </div>
        </div>
    </aside>
    <!-- END SIDEBAR HTML -->

    <!-- Overlay for mobile sidebar -->
    <div id="sidebar-overlay"></div>
    
    
    <!-- 
      START MAIN CONTENT WRAPPER
    -->
    <div id="main-content-wrapper">
        
        <!-- Mobile-Only Header -->
        <header id="mobile-header" class="md:hidden flex items-center justify-between px-4">
            <span class="text-xl font-bold text-gray-900">Teacher Portal</span>
            <button id="mobile-menu-button" class="p-2 rounded-md text-gray-500 hover:text-gray-900 hover:bg-gray-100">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
        </header>

        <!-- 
          START PAGE-SPECIFIC CONTENT
        -->
        <main class="p-4 md:p-8">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">Log Fee Payment</h1>
            
            <!-- This message shows if they don't have permission -->
            <div id="permission-denied" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                <strong class="font-bold">Access Denied!</strong>
                <span class="block sm:inline">You do not have permission to log fees. Please contact your admin.</span>
            </div>
            
            <!-- This is the main content, hidden until permissions are checked -->
            <div id="fees-content" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <div class="lg:col-span-2">
                    <form id="fee-form" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 space-y-4">
                        
                        <div>
                            <label for="batch-select" class="form-label">1. Select Batch</label>
                            <select id="batch-select" class="form-select">
                                <option value="">Loading your batches...</option>
                            </select>
                        </div>

                        <div>
                            <label for="student-select" class="form-label">2. Select Student</label>
                            <select id="student-select" class="form-select" disabled>
                                <option value="">Select a batch first</option>
                            </select>
                        </div>

                        <div>
                            <label for="payment-method" class="form-label">3. Payment Method</label>
                            <select id="payment-method" class="form-select" required>
                                <option value="">Select a method</option>
                                <option value="Cash">Cash</option>
                                <option value="UPI">UPI</option>
                                <option value="Card">Card</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>

                        <div id="cash-receiver-group" class="hidden">
                            <label for="cash-receiver" class="form-label">Cash Received By</label>
                            <select id="cash-receiver" class="form-select">
                                <option value="">Select person</option>
                                <option value="Teacher">Teacher</option>
                                <option value="Reception">Reception</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>

                        <!-- NEW: Hidden dropdown for selecting specific teacher -->
                        <div id="teacher-receiver-group" class="hidden">
                            <label for="teacher-receiver-select" class="form-label">Select Teacher</label>
                            <select id="teacher-receiver-select" class="form-select">
                                <option value="">Loading teachers...</option>
                            </select>
                        </div>

                        <div id="upi-qr-group" class="hidden p-4 border border-gray-200 rounded-lg text-center">
                            <label class="form-label mb-2">Scan QR Code for UPI Payment</label>
                            <img src="https://placehold.co/200x200/png?text=Institution+QR+Code" alt="UPI QR Code" class="mx-auto rounded-md">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="amount" class="form-label">4. Amount (INR)</label>
                                <input type="number" id="amount" class="form-input" placeholder="e.g., 5000" min="1" step="1" required>
                            </div>
                            <div>
                                <label for="payment-date" class="form-label">5. Payment Date</label>
                                <input type="date" id="payment-date" class="form-input" required>
                            </div>
                        </div>

                        <div>
                            <label for="notes" class="form-label">6. Notes (Optional)</label>
                            <textarea id="notes" class="form-textarea" rows="3" placeholder="e.g., Paid via UPI, partial payment..."></textarea>
                        </div>

                        <div>
                            <button type="submit" id="save-fee-button" class="form-submit-button w-full md:w-auto">
                                Save Fee Payment
                            </button>
                        </div>
                    </form>
                </div>

                <div id="student-fee-details" class="lg:col-span-1 hidden">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 sticky top-24">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4">Manage Fees</h3>

                        <div id="fee-status-loading" class="hidden flex flex-col items-center justify-center py-8">
                            <div class="spinner"></div>
                            <span class="mt-2 text-sm text-gray-500">Loading details...</span>
                        </div>

                        <div id="fee-status-content" class="hidden space-y-4">
                            
                            <div class="space-y-2 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Total Course Fee:</span>
                                    <span id="total-course-fee" class="font-medium text-gray-700">₹0.00</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Total Paid:</span>
                                    <span id="total-paid" class="font-medium text-green-600">₹0.00</span>
                                </div>
                                <div class="flex justify-between text-base font-semibold">
                                    <span class="text-gray-900">Balance Due:</span>
                                    <span id="total-balance" class="text-gray-900">₹0.00</span>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-md font-semibold text-gray-900 mb-2">Payment History</h4>
                                <div class="overflow-y-auto max-h-60 payment-history-scroll border rounded-lg">
                                    <table class="min-w-full text-sm">
                                        <thead class="bg-gray-50 sticky top-0">
                                            <tr>
                                                <th class="py-2 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                <th class="py-2 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                                <th class="py-2 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                                                <th class="py-2 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="payment-history-table-body" class="divide-y divide-gray-200">
                                            <tr>
                                                <td colspan="4" class="py-3 px-2 text-center text-gray-500">
                                                    Loading...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </main>
        <!-- END PAGE-SPECIFIC CONTENT -->
    
    </div>
    <!-- END MAIN CONTENT WRAPPER -->


    <!-- 
      START JAVASCRIPT
      All JavaScript for this page is right here.
    -->
    <script type="module">
        // 1. Import the Supabase library
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        // 2. Add your Supabase keys here
        const SUPABASE_URL = 'https://mclizdhmmzckhjnocktz.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jbGl6ZGhtbXpja2hqbm9ja3R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNDk5MzUsImV4cCI6MjA3NzgyNTkzNX0.zKvs2XDOvcJfb_mCDHOMsJwRKvUViWWTjZRcOKExAfI'
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // We will store the user and profile globally on the page
        let currentUser = null;
        let userProfile = null;
        let allTeachers = []; // To store teacher list


        // --- 3. THE SECURITY GUARD ---
        async function checkAuth() {
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            if (sessionError || !session) {
                window.location.href = 'teacher_login.html';
                return;
            }
            currentUser = session.user;
            
            const { data: profile, error: profileError } = await supabase
                .from('profiles')
                .select('role, institute_id, full_name, is_active, can_manage_attendance, can_manage_fees, can_add_students')
                .eq('id', currentUser.id)
                .single();
                
            if (profileError) {
                await supabase.auth.signOut();
                window.location.href = 'teacher_login.html';
                return;
            }
            
            userProfile = profile; 

            if (profile.role !== 'teacher' || !profile.is_active) {
                alert('You are not an active teacher. Please contact your admin.');
                await supabase.auth.signOut();
                window.location.href = 'teacher_login.html';
                return;
            }
            
            runPageLogic();
        }

        // --- 4. SIDEBAR & NAVIGATION LOGIC ---
        function setupSidebarAndNav() {
            // ... (Same as before, no changes here)
            const logoutButton = document.getElementById('logout-button');
            const userEmailSpan = document.getElementById('user-email-sidebar');
            const desktopToggleButton = document.getElementById('sidebar-toggle-button');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            logoutButton.addEventListener('click', async () => {
                await supabase.auth.signOut();
                window.location.href = 'teacher_login.html';
            });

            if (currentUser) {
                userEmailSpan.textContent = currentUser.email;
            }

            const currentPage = "teacher_fees";
            const navLinks = document.querySelectorAll("#sidebar-nav a");
            navLinks.forEach(link => {
                if (link.getAttribute("data-page") === currentPage) {
                    link.classList.add("active");
                }
            });

            desktopToggleButton.addEventListener('click', () => {
                document.body.classList.toggle('sidebar-retracted');
            });
            mobileMenuButton.addEventListener('click', () => {
                document.body.classList.add('sidebar-mobile-open');
            });
            sidebarOverlay.addEventListener('click', () => {
                document.body.classList.remove('sidebar-mobile-open');
            });

            if (userProfile?.can_manage_attendance) {
                document.getElementById('nav-attendance').style.display = 'flex';
            }
            if (userProfile?.can_manage_fees) {
                document.getElementById('nav-fees').style.display = 'flex';
            }
            if (userProfile?.can_add_students) {
                document.getElementById('nav-students').style.display = 'flex';
            }
        }
        
        // --- 5. PAGE-SPECIFIC LOGIC (FOR LOGGING FEES) ---

        // Get page elements
        const permissionDeniedEl = document.getElementById('permission-denied');
        const feesContentEl = document.getElementById('fees-content');
        const feeForm = document.getElementById('fee-form');
        const batchSelect = document.getElementById('batch-select');
        const studentSelect = document.getElementById('student-select');
        const amountInput = document.getElementById('amount');
        const dateInput = document.getElementById('payment-date');
        const notesInput = document.getElementById('notes');
        const saveButton = document.getElementById('save-fee-button');

        const paymentMethodSelect = document.getElementById('payment-method');
        const cashReceiverGroup = document.getElementById('cash-receiver-group');
        const cashReceiverSelect = document.getElementById('cash-receiver');
        const upiQrGroup = document.getElementById('upi-qr-group');
        
        const teacherReceiverGroup = document.getElementById('teacher-receiver-group');
        const teacherReceiverSelect = document.getElementById('teacher-receiver-select');

        const studentFeeDetails = document.getElementById('student-fee-details');
        const feeStatusLoading = document.getElementById('fee-status-loading');
        const feeStatusContent = document.getElementById('fee-status-content');
        
        const totalCourseFeeEl = document.getElementById('total-course-fee');
        const totalPaidEl = document.getElementById('total-paid');
        const totalBalanceEl = document.getElementById('total-balance');
        const paymentHistoryTableBody = document.getElementById('payment-history-table-body');


        const formatter = new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 0,
            maximumFractionDigits: 2,
        });

        async function fetchAllTeachers() {
            if (!userProfile) return;
            
            // FIXED: Removed the bad copy-pasted code. This function now *only* fetches profiles.
            const { data, error } = await supabase
                .from('profiles')
                .select('id, full_name')
                .eq('institute_id', userProfile.institute_id)
                .in('role', ['teacher', 'admin'])
                .eq('is_active', true)
                .order('full_name', { ascending: true });

            if (error) {
                console.error('Error fetching teacher/admin list:', error);
                teacherReceiverSelect.innerHTML = '<option value="">Could not load users</option>';
            } else {
                allTeachers = data; // Store globally
                populateTeacherDropdown(); // Fill the dropdown
            }
        }

        function populateTeacherDropdown() {
            teacherReceiverSelect.innerHTML = ''; // Clear
            teacherReceiverSelect.appendChild(new Option('Select teacher', ''));
            
            allTeachers.forEach(teacher => {
                // Add the logged-in user with a "(Me)"
                const name = (teacher.id === currentUser.id) ? `${teacher.full_name} (Me)` : teacher.full_name;
                teacherReceiverSelect.appendChild(new Option(name, teacher.id));
            });
        }

        async function fetchAssignedBatches() {
            if (!currentUser || !userProfile) {
                batchSelect.innerHTML = '<option value="">Unable to load batches</option>';
                return;
            }

            const { data: assignments, error: assignErr } = await supabase
                .from('batch_teachers')
                .select('batch_id')
                .eq('teacher_id', currentUser.id)
                .eq('institute_id', userProfile.institute_id);

            if (assignErr) {
                batchSelect.innerHTML = `<option value="">Error: ${assignErr.message}</option>`;
                return;
            }
            if (!assignments?.length) {
                batchSelect.innerHTML = '<option value="">Admin has not assigned you any batches</option>';
                return;
            }

            const batchIds = assignments.map(a => a.batch_id).filter(Boolean);

            const { data: batches, error: batchErr } = await supabase
                .from('batches')
                .select('id, name')
                .in('id', batchIds)
                .eq('institute_id', userProfile.institute_id);

            if (batchErr) {
                batchSelect.innerHTML = `<option value="">Error: ${batchErr.message}</option>`;
                return;
            }
            if (!batches?.length) {
                batchSelect.innerHTML = '<option value="">No batches found in system</option>';
                return;
            }

            batchSelect.innerHTML = '<option value="">Select a batch</option>';
            for (const b of batches) {
                const opt = document.createElement('option');
                opt.value = b.id;
                opt.textContent = b.name;
                batchSelect.appendChild(opt);
            }
        }

        async function handleBatchSelect() {
            const batchId = batchSelect.value;
            studentFeeDetails.style.display = 'none';

            if (!batchId) {
                studentSelect.innerHTML = '<option value="">Select a batch first</option>';
                studentSelect.disabled = true;
                return;
            }

            studentSelect.innerHTML = '<option value="">Loading students...</option>';
            studentSelect.disabled = true;

            const { data: students, error } = await supabase
                .from('students')
                .select('id, full_name, total_fee_due') // FIXED: Added total_fee_due
                .eq('batch_id', batchId)
                .eq('institute_id', userProfile.institute_id)
                .order('full_name', { ascending: true });

            if (error) {
                studentSelect.innerHTML = `<option value="">Error: ${error.message}</option>`;
                return;
            }

            if (!students?.length) {
                studentSelect.innerHTML = '<option value="">No students found in this batch</option>';
                return;
            }

            studentSelect.innerHTML = '<option value="">Select a student</option>';
            for (const s of students) {
                const opt = document.createElement('option');
                opt.value = s.id;
                // FIXED: Store the total_fee_due on the option itself
                opt.dataset.totalFeeDue = s.total_fee_due; 
                opt.textContent = s.full_name;
                studentSelect.appendChild(opt);
            }
            studentSelect.disabled = false;
        }

        function handlePaymentMethodChange() {
            const method = paymentMethodSelect.value;
            cashReceiverGroup.style.display = (method === 'Cash') ? 'block' : 'none';
            upiQrGroup.style.display = (method === 'UPI') ? 'block' : 'none';
            
            if (method !== 'Cash') {
                teacherReceiverGroup.style.display = 'none';
                cashReceiverSelect.value = ''; // Reset cash receiver
            }
        }

        function handleCashReceiverChange() {
            const receiver = cashReceiverSelect.value;
            teacherReceiverGroup.style.display = (receiver === 'Teacher' || receiver === 'Admin') ? 'block' : 'none';
        }

        async function handleStudentSelect() {
            const selectedOption = studentSelect.options[studentSelect.selectedIndex];
            const studentId = selectedOption.value;
            
            if (!studentId) {
                studentFeeDetails.style.display = 'none';
                return;
            }

            studentFeeDetails.style.display = 'block';
            feeStatusLoading.style.display = 'flex';
            feeStatusContent.style.display = 'none'; 

            // --- THIS IS THE NEW LOGIC ---
            // 1. Get the student's total_fee_due from the option's dataset
            //    (We fetched this in handleBatchSelect)
            const totalFee = parseFloat(selectedOption.dataset.totalFeeDue || 0);
            
            // 2. Fetch payment history (FIXED: to use 'date_paid' column)
            const { data: payments, error } = await supabase
                .from('fees')
                .select('amount_paid, date_paid, payment_method, notes') // FIXED: Was 'date'
                .eq('student_id', studentId)
                .order('date_paid', { ascending: false }); // FIXED: Was 'date'

            if (error) {
                alert('Error fetching payment history: ' + error.message);
                studentFeeDetails.style.display = 'none';
                return;
            }

            // 3. Calculate totals
            const totalPaid = payments.reduce((acc, p) => acc + (p.amount_paid || 0), 0);
            const dueAmount = totalFee - totalPaid;

            // 4. Render Summary
            totalCourseFeeEl.textContent = formatter.format(totalFee);
            totalPaidEl.textContent = formatter.format(totalPaid);
            totalBalanceEl.textContent = formatter.format(dueAmount);
            
            if (dueAmount > 0) {
                totalBalanceEl.classList.add('text-red-600');
                totalBalanceEl.classList.remove('text-gray-900', 'text-green-600');
            } else {
                totalBalanceEl.classList.add('text-green-600');
                totalBalanceEl.classList.remove('text-gray-900', 'text-red-600');
            }
            
            // 5. Render Payment History Table
            paymentHistoryTableBody.innerHTML = ''; // Clear old list
            if (payments.length === 0) {
                paymentHistoryTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="py-3 px-2 text-center text-gray-500">
                            No payments found.
                        </td>
                    </tr>
                `;
            } else {
                payments.forEach(p => {
                    const row = document.createElement('tr');
                    const notesText = p.notes ? p.notes.substring(0, 20) + (p.notes.length > 20 ? '...' : '') : 'N/A';
                    const notesTitle = p.notes || 'No notes';

                    row.innerHTML = `
                        <td class="py-2 px-2 text-gray-800 whitespace-noww-rap">${new Date(p.date_paid).toLocaleDateString()}</td> <!-- FIXED: Was 'p.date_paid' but wrong -->
                        <td class="py-2 px-2 text-gray-800 whitespace-nowrap">${formatter.format(p.amount_paid)}</td>
                        <td class="py-2 px-2 text-gray-500 whitespace-nowrap">${p.payment_method || 'N/A'}</td>
                        <td class="py-2 px-2 text-gray-500" title="${notesTitle}">${notesText}</td>
                    `;
                    paymentHistoryTableBody.appendChild(row);
                });
            }

            feeStatusLoading.style.display = 'none';
            feeStatusContent.style.display = 'block'; // Show content
        }

        async function saveFeePayment(e) {
            e.preventDefault();
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';

            const student_id = studentSelect.value;
            const amount = amountInput.value;
            const payment_date = dateInput.value; // Get the date from the form
            const notes = notesInput.value;
            const institute_id = userProfile.institute_id;
            
            const payment_method = paymentMethodSelect.value;
            const cash_receiver_role = (payment_method === 'Cash') ? cashReceiverSelect.value : null;
            
            let received_by_id = null; // FIXED: This will be our `recorded_by_admin_id`
            if (payment_method === 'Cash') {
                if (cash_receiver_role === 'Teacher') {
                    received_by_id = teacherReceiverSelect.value;
                } else if (cash_receiver_role === 'Admin') {
                    // Find the Admin's ID from the allTeachers list, or default to current user
                    const adminUser = allTeachers.find(u => u.id === teacherReceiverSelect.value);
                    received_by_id = adminUser ? adminUser.id : currentUser.id; // Default to self
                }
                // If "Reception", received_by_id remains null
            } else {
                // If not cash, the current teacher is recording it
                received_by_id = currentUser.id;
            }


            // --- Validation ---
            if (!student_id || !amount || !payment_date || !payment_method) {
                alert('Please fill in all required fields: Student, Payment Method, Amount, and Date.');
                saveButton.disabled = false;
                saveButton.textContent = 'Save Fee Payment';
                return;
            }
            if (payment_method === 'Cash' && !cash_receiver_role) {
                alert('Please select who received the cash.');
                saveButton.disabled = false;
                saveButton.textContent = 'Save Fee Payment';
                return;
            }
            if (payment_method === 'Cash' && (cash_receiver_role === 'Teacher' || cash_receiver_role === 'Admin') && !received_by_id) {
                alert('Please select the specific Teacher or Admin who received the cash.');
                saveButton.disabled = false;
                saveButton.textContent = 'Save Fee Payment';
                return;
            }
            
            // FIXED: This object now matches the schema
            const feeRecord = {
                student_id,
                amount_paid: parseFloat(amount),
                // FIXED: Use the 'date_paid' column
                date_paid: new Date(payment_date).toISOString(), 
                notes: notes || null,
                institute_id,
                payment_method,
                recorded_by_admin_id: received_by_id // FIXED: Use 'recorded_by_admin_id'
            };

            const { error } = await supabase
                .from('fees')
                .insert(feeRecord);

            if (error) {
                console.error('Error saving fee:', error);
                alert(`Error: ${error.message}`);
            } else {
                alert('Fee payment saved successfully!');
                feeForm.reset(); 
                
                // Reset conditional fields
                handlePaymentMethodChange();
                handleCashReceiverChange(); // Hides the teacher dropdown
                
                // Refresh the student details
                handleStudentSelect();
                
                dateInput.value = new Date().toISOString().split('T')[0];
            }

            saveButton.disabled = false;
            saveButton.textContent = 'Save Fee Payment';
        }

        function runPageLogic() {
            setupSidebarAndNav();
            
            if (!userProfile?.can_manage_fees) {
                permissionDeniedEl.style.display = 'block';
                return;
            }
            
            feesContentEl.style.display = 'grid';
            dateInput.value = new Date().toISOString().split('T')[0];

            // Load initial data
            fetchAssignedBatches();
            fetchAllTeachers(); 

            // Set up event listeners
            batchSelect.addEventListener('change', handleBatchSelect);
            studentSelect.addEventListener('change', handleStudentSelect);
            paymentMethodSelect.addEventListener('change', handlePaymentMethodChange);
            cashReceiverSelect.addEventListener('change', handleCashReceiverChange); 
            feeForm.addEventListener('submit', saveFeePayment);
        }

        // --- 6. START THE APP ---
        checkAuth();
        
    </script>
</body>
</html>